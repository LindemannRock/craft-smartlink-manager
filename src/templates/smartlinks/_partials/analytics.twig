{#
 # Per-Smartlink Analytics Tab
 #
 # Uses the base plugin's analytics-panel partial for consistent styling.
 #
 # Variables available:
 # - smartLink: The smartlink record
 # - analyticsService: The analytics service
 #}

{# Get analytics data for this smartlink #}
{% set plugin = craft.app.plugins.getPlugin('smartlink-manager') %}
{% set settings = plugin.settings %}
{% set analyticsService = plugin.analytics %}
{% set pluginHandle = pluginHandle ?? plugin.id %}
{% set dateRange = craft.app.request.getQueryParam('range') ?? lrDefaultDateRange(pluginHandle) %}
{% set analytics = analyticsService.getSmartLinkAnalytics(smartLink.id, dateRange) ?? {totalClicks: 0} %}

{# Extract analytics breakdown data #}
{% set deviceStats = analytics.deviceBreakdown ?? {} %}
{% set platformStats = analytics.platformBreakdown ?? {} %}

{% embed 'lindemannrock-base/_partials/analytics-panel' with {
    config: {
        pluginHandle: pluginHandle,
        dateRange: {
            enabled: true,
            current: dateRange,
            param: 'range',
            hash: 'analytics',
        },
        export: {
            action: 'smartlink-manager/analytics/export',
            permission: 'smartLinkManager:exportAnalytics',
            extraParams: {smartLinkId: smartLink.id},
        },
    }
} %}
    {% block content %}
        {% if analytics.totalClicks == 0 %}
            <div class="lr-analytics-empty">
                <p>{{ "No analytics data yet"|t('smartlink-manager') }}</p>
                <p class="light">{{ "Analytics will appear here once your {singularName} starts receiving clicks."|t('smartlink-manager', {singularName: smartlinkHelper.lowerDisplayName}) }}</p>
            </div>
        {% else %}
            {# Summary Stats #}
            <div class="lr-unified-cards">
                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.totalClicks,
                    description: 'Total Interactions'|t('smartlink-manager'),
                    align: 'center',
                } only %}

                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.uniqueClicks,
                    description: 'Unique Visitors'|t('smartlink-manager'),
                    align: 'center',
                } only %}

                {% include 'lindemannrock-base/_components/cards/unified-card' with {
                    value: analytics.averageClicksPerDay|number_format(2),
                    valueIsFormatted: true,
                    description: 'Avg. Interactions/Day'|t('smartlink-manager'),
                    align: 'center',
                } only %}
            </div>

            {# Charts Section #}
            <div class="lr-analytics-charts two-columns">
                {# Device Breakdown #}
                <div class="lr-chart-container">
                    <h3>{{ "Device Breakdown"|t('smartlink-manager') }}</h3>
                    {% if deviceStats|length %}
                        <div class="lr-chart-height-250 lr-chart-center">
                            <canvas id="device-breakdown-chart"></canvas>
                        </div>
                    {% else %}
                        <div class="lr-chart-empty">{{ "Device information not available"|t('smartlink-manager') }}</div>
                    {% endif %}
                </div>

                {# Operating System Breakdown #}
                <div class="lr-chart-container">
                    <h3>{{ "Operating System"|t('smartlink-manager') }}</h3>
                    {% if platformStats|length %}
                        <div class="lr-chart-height-250 lr-chart-center">
                            <canvas id="os-breakdown-chart"></canvas>
                        </div>
                    {% else %}
                        <div class="lr-chart-empty">{{ "OS information not available"|t('smartlink-manager') }}</div>
                    {% endif %}
                </div>
            </div>

            {# Recent Clicks #}
            {% set recentClicks = analyticsService.getRecentClicks(smartLink.id, 20, dateRange) %}
            {% if recentClicks|length %}
                <div class="lr-chart-container lr-mt-24">
                    <h3>{{ "Interactions (Last 20)"|t('smartlink-manager') }}</h3>
                    <div class="lr-table-scroll">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ "Date"|t('smartlink-manager') }}</th>
                                    <th>{{ "Time"|t('smartlink-manager') }}</th>
                                    <th>{{ "Site"|t('smartlink-manager') }}</th>
                                    <th>{{ "Type"|t('smartlink-manager') }}</th>
                                    <th>{{ "Button"|t('smartlink-manager') }}</th>
                                    <th>{{ "Source"|t('smartlink-manager') }}</th>
                                    <th>{{ "Destination URL"|t('smartlink-manager') }}</th>
                                    <th>{{ "Device"|t('smartlink-manager') }}</th>
                                    <th>{{ "OS"|t('smartlink-manager') }}</th>
                                    {% if settings.enableGeoDetection %}
                                        <th>{{ "Location"|t('smartlink-manager') }}</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for click in recentClicks %}
                                    {% set metadata = click.metadata ? click.metadata|json_decode : {} %}
                                    {% set clickType = metadata.clickType ?? 'redirect' %}
                                    <tr>
                                        <td>{{ click.dateCreated|lrDate('short') }}</td>
                                        <td>{{ click.dateCreated|lrTime('short') }}</td>
                                        <td>
                                            {% if click.siteId %}
                                                {% set site = craft.app.sites.getSiteById(click.siteId) %}
                                                {{ site ? site.name : '—' }}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if clickType == 'button' %}
                                                {{ "Button"|t('smartlink-manager') }}
                                            {% else %}
                                                {{ "Redirect"|t('smartlink-manager') }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if clickType == 'button' %}
                                                {% if metadata.platform is defined %}
                                                    {% set platformDisplay = {
                                                        'ios': 'iOS',
                                                        'android': 'Android',
                                                        'macos': 'macOS',
                                                        'windows': 'Windows',
                                                        'linux': 'Linux',
                                                        'huawei': 'Huawei',
                                                        'amazon': 'Amazon',
                                                        'other': 'Other'
                                                    } %}
                                                    {{ platformDisplay[metadata.platform] ?? metadata.platform|capitalize }}
                                                {% else %}
                                                    —
                                                {% endif %}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set source = metadata.source ?? 'direct' %}
                                            {% if source == 'qr' %}
                                                {{ "QR"|t('smartlink-manager') }}
                                            {% elseif source == 'landing' %}
                                                {{ "Landing"|t('smartlink-manager') }}
                                            {% else %}
                                                {{ "Direct"|t('smartlink-manager') }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if clickType == 'button' %}
                                                {% set url = metadata.buttonUrl ?? '' %}
                                            {% else %}
                                                {% set url = metadata.redirectUrl ?? metadata.buttonUrl ?? '' %}
                                            {% endif %}
                                            {% if url %}
                                                {% set domain = url|replace({'https://': '', 'http://': ''})|split('/')[0] %}
                                                <span title="{{ url }}">{{ domain|truncate(30) }}</span>
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td>{{ click.deviceType ? click.deviceType|capitalize : '—' }}</td>
                                        <td>{{ click.osName ?? '—' }}</td>
                                        {% if settings.enableGeoDetection %}
                                            <td>
                                                {% if click.city and click.country %}
                                                    {{ click.city }}, {{ click.country }}
                                                {% elseif click.country %}
                                                    {{ click.country }}
                                                {% else %}
                                                    —
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endblock %}
{% endembed %}

{# Chart initialization - uses lrCreateChart from AnalyticsAsset #}
{% if analytics.totalClicks > 0 %}
<script>
(function() {
    if (window.lrSmartlinkPanelChartsBound) {
        return;
    }
    window.lrSmartlinkPanelChartsBound = true;

document.addEventListener('lr:panelChartsReady', function() {
    var chartColors = window.lrChartColors || ['#0EA5E9', '#8B5CF6', '#F59E0B', '#10B981', '#EF4444', '#6B7280'];
    var chartPrefix = (window.lrAnalyticsConfig && window.lrAnalyticsConfig.prefix) ? window.lrAnalyticsConfig.prefix : 'analytics';

    function destroyChart(canvasId) {
        var chartKey = canvasId.replace(/-/g, '_');
        if (window.lrChartInstances && window.lrChartInstances[chartPrefix] && window.lrChartInstances[chartPrefix][chartKey]) {
            window.lrChartInstances[chartPrefix][chartKey].destroy();
            delete window.lrChartInstances[chartPrefix][chartKey];
        }
    }

    function resetChartState(canvas) {
        if (!canvas) return;
        canvas.style.display = '';
        var parent = canvas.parentElement || canvas.parentNode;
        if (!parent) return;
        parent.querySelectorAll('.zilch').forEach(function(el) { el.remove(); });
    }

    function renderEmptyState(canvasId, message) {
        var ctx = document.getElementById(canvasId);
        if (!ctx) return;
        resetChartState(ctx);
        destroyChart(canvasId);
        ctx.style.display = 'none';
        var parent = ctx.parentElement || ctx.parentNode;
        if (!parent) return;
        var emptyMsg = document.createElement('div');
        emptyMsg.className = 'zilch';
        emptyMsg.style.padding = '48px 24px';
        emptyMsg.style.textAlign = 'center';
        var p = document.createElement('p');
        p.textContent = message;
        emptyMsg.appendChild(p);
        parent.appendChild(emptyMsg);
    }

    // Device Breakdown Chart
    {% if deviceStats|length %}
    var deviceCtx = document.getElementById('device-breakdown-chart');
    if (deviceCtx) {
        resetChartState(deviceCtx);
        window.lrCreateChart('device-breakdown-chart', 'doughnut', {
            labels: {{ deviceStats|keys|json_encode|raw }},
            datasets: [{
                data: {{ deviceStats|values|json_encode|raw }},
                backgroundColor: chartColors
            }]
        }, {
            plugins: { legend: { position: 'bottom' } }
        });
    }
    {% else %}
    renderEmptyState('device-breakdown-chart', '{{ "No device data available for the selected filters."|t('smartlink-manager')|e('js') }}');
    {% endif %}

    // OS Breakdown Chart
    {% if platformStats|length %}
    var osCtx = document.getElementById('os-breakdown-chart');
    if (osCtx) {
        resetChartState(osCtx);
        window.lrCreateChart('os-breakdown-chart', 'doughnut', {
            labels: {{ platformStats|keys|json_encode|raw }},
            datasets: [{
                data: {{ platformStats|values|json_encode|raw }},
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6B7280']
            }]
        }, {
            plugins: { legend: { position: 'bottom' } }
        });
    }
    {% else %}
    renderEmptyState('os-breakdown-chart', '{{ "No OS data available for the selected filters."|t('smartlink-manager')|e('js') }}');
    {% endif %}
});
})();
</script>
{% endif %}
