{% extends 'lindemannrock-base/_layouts/cp-utilities' %}

{# Permission checks #}
{% set canViewLinks = currentUser.can('smartLinkManager:viewLinks') %}
{% set canViewAnalytics = currentUser.can('smartLinkManager:viewAnalytics') %}
{% set canManageSettings = currentUser.can('smartLinkManager:manageSettings') %}
{% set canClearCache = currentUser.can('smartLinkManager:clearCache') %}
{% set canClearAnalytics = currentUser.can('smartLinkManager:clearAnalytics') %}

{% set storageMethod = settings.cacheStorageMethod %}

{% set hasNavigation = canViewLinks or (settings.enableAnalytics and canViewAnalytics) or canManageSettings %}
{% set hasCacheManagement = (settings.enableQrCodeCache or settings.cacheDeviceDetection) and canClearCache %}
{% set hasAnalyticsManagement = settings.enableAnalytics and canClearAnalytics %}
{% set hasAnyQuickAction = hasNavigation or hasCacheManagement or hasAnalyticsManagement %}

{% set utilitiesConfig = {
    plugin: {
        handle: 'smartlink-manager',
        name: smartlinkHelper.fullName,
    },
    page: {
        title: 'Overview'|t('smartlink-manager'),
        description: 'Monitor link performance, track analytics, and manage cache for your {singularName} redirects and QR codes.'|t('smartlink-manager', {singularName: smartlinkHelper.lowerDisplayName}),
    },
} %}

{% block overview %}
    {# Links Status Card - dynamic sub-boxes based on counts #}
    {% set linksSubBoxes = [{value: activeLinks, label: 'Active'|t('smartlink-manager')}] %}
    {% if pendingLinks > 0 or (expiredLinks == 0 and disabledLinks == 0) %}
        {% set linksSubBoxes = linksSubBoxes|merge([{value: pendingLinks, label: 'Pending'|t('smartlink-manager')}]) %}
    {% endif %}
    {% if expiredLinks > 0 or (pendingLinks == 0 and disabledLinks == 0) %}
        {% set linksSubBoxes = linksSubBoxes|merge([{value: expiredLinks, label: 'Expired'|t('smartlink-manager')}]) %}
    {% endif %}
    {% if disabledLinks > 0 and linksSubBoxes|length < 3 %}
        {% set linksSubBoxes = linksSubBoxes|merge([{value: disabledLinks, label: 'Disabled'|t('smartlink-manager')}]) %}
    {% endif %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Links Status'|t('smartlink-manager'),
        color: lrPaletteColor('emerald').color,
        value: totalLinks,
        description: 'Total {pluginName}'|t('smartlink-manager', {pluginName: smartlinkHelper.pluralLowerDisplayName}),
        subBoxes: linksSubBoxes,
    } only %}

    {# Performance Card #}
    {% if settings.enableAnalytics %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Performance'|t('smartlink-manager'),
            color: lrPaletteColor('sky').color,
            value: totalClicks,
            description: 'Total interactions tracked'|t('smartlink-manager'),
            subBoxes: [
                {value: qrScans, label: 'QR Scans'|t('smartlink-manager')},
                {value: autoRedirects, label: 'Redirects'|t('smartlink-manager')},
                {value: buttonClicks, label: 'Clicks'|t('smartlink-manager')},
            ],
        } only %}
    {% endif %}

    {# Cache Status Card - varies by storage method #}
    {% if storageMethod == 'redis' %}
        {% set cacheSubBoxes = [] %}
        {% if settings.enableQrCodeCache %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: '✓', label: 'QR Codes'|t('smartlink-manager')}]) %}
        {% endif %}
        {% if settings.cacheDeviceDetection %}
            {% set cacheSubBoxes = cacheSubBoxes|merge([{value: '✓', label: 'Devices'|t('smartlink-manager')}]) %}
        {% endif %}

        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Cache Status'|t('smartlink-manager') ~ ' (Redis)',
            color: lrPaletteColor('emerald').color,
            value: 'Active'|t('smartlink-manager'),
            subBoxes: cacheSubBoxes,
        } only %}
    {% else %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Cache Status'|t('smartlink-manager') ~ ' (File)',
            color: lrPaletteColor('emerald').color,
            value: qrCacheFiles + deviceCacheFiles,
            description: 'Total cached entries'|t('smartlink-manager'),
            subBoxes: [
                {value: qrCacheFiles, label: 'QR Codes'|t('smartlink-manager')},
                {value: deviceCacheFiles, label: 'Devices'|t('smartlink-manager')},
            ],
        } only %}
    {% endif %}
{% endblock %}

{% block quickActions %}
    {% if hasAnyQuickAction %}
        {# Navigation Section #}
        {% if hasNavigation %}
            {% set navButtons = [] %}
            {% if canViewLinks %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'Manage {pluginName}'|t('smartlink-manager', {pluginName: smartlinkHelper.pluralDisplayName}), url: url('smartlink-manager')}]) %}
            {% endif %}
            {% if settings.enableAnalytics and canViewAnalytics %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'View Analytics'|t('smartlink-manager'), url: url('smartlink-manager/analytics')}]) %}
            {% endif %}
            {% if canManageSettings %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'View Settings'|t('smartlink-manager'), url: url('smartlink-manager/settings')}]) %}
            {% endif %}

            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Navigation'|t('smartlink-manager'),
                description: 'Access main plugin sections'|t('smartlink-manager'),
                buttons: navButtons,
            } only %}
        {% endif %}

        {# Cache Management Section #}
        {% if hasCacheManagement %}
            {% set cacheButtons = [] %}
            {% if settings.enableQrCodeCache %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-qr-cache',
                    label: 'Clear QR Cache'|t('smartlink-manager'),
                    count: storageMethod != 'redis' ? qrCacheFiles : null,
                }]) %}
            {% endif %}
            {% if settings.cacheDeviceDetection %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-device-cache',
                    label: 'Clear Device Cache'|t('smartlink-manager'),
                    count: storageMethod != 'redis' ? deviceCacheFiles : null,
                }]) %}
            {% endif %}
            {% if settings.enableQrCodeCache and settings.cacheDeviceDetection %}
                {% set cacheButtons = cacheButtons|merge([{
                    id: 'clear-all-caches',
                    label: 'Clear All Caches'|t('smartlink-manager'),
                    class: 'btn secondary',
                    count: storageMethod != 'redis' ? (qrCacheFiles + deviceCacheFiles) : null,
                }]) %}
            {% endif %}

            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Cache Management'|t('smartlink-manager'),
                description: 'Clear cached data to force regeneration. Useful after changing QR code settings or when troubleshooting.'|t('smartlink-manager'),
                showSeparator: hasNavigation,
                buttons: cacheButtons,
            } only %}
        {% endif %}

        {# Analytics Management Section #}
        {% if hasAnalyticsManagement %}
            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Analytics Data Management'|t('smartlink-manager'),
                description: 'Permanently delete all analytics tracking data. This action cannot be undone!'|t('smartlink-manager'),
                showSeparator: hasNavigation or hasCacheManagement,
                buttons: [
                    {id: 'clear-all-analytics', label: 'Clear All Analytics'|t('smartlink-manager'), class: 'btn secondary', count: totalClicks},
                ],
            } only %}
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
{% js %}
{% if settings.qrCodeCacheDuration > 0 %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-qr-cache',
    action: actionUrl('smartlink-manager/settings/clear-qr-cache'),
    errorMessage: 'Failed to clear QR cache'|t('smartlink-manager'),
} only %}
{% endif %}

{% if settings.cacheDeviceDetection %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-device-cache',
    action: actionUrl('smartlink-manager/settings/clear-device-cache'),
    errorMessage: 'Failed to clear device cache'|t('smartlink-manager'),
} only %}
{% endif %}

{% if settings.enableQrCodeCache and settings.cacheDeviceDetection %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-all-caches',
    action: actionUrl('smartlink-manager/settings/clear-all-caches'),
    confirm: 'Are you sure you want to clear all {pluginName} caches?'|t('smartlink-manager', {pluginName: smartlinkHelper.fullName}),
    errorMessage: 'Failed to clear caches'|t('smartlink-manager'),
} only %}
{% endif %}

{% if settings.enableAnalytics %}
{% include 'lindemannrock-base/_layouts/cp-utilities/_ajax-button' with {
    id: 'clear-all-analytics',
    action: actionUrl('smartlink-manager/settings/clear-all-analytics'),
    confirm: 'Are you sure you want to permanently delete ALL analytics data? This action cannot be undone!'|t('smartlink-manager'),
    confirmSecond: 'This will delete all click tracking data and reset all click counts. Are you absolutely sure?'|t('smartlink-manager'),
    errorMessage: 'Failed to clear analytics'|t('smartlink-manager'),
    reloadDelay: 2000,
} only %}
{% endif %}
{% endjs %}
{% endblock %}
