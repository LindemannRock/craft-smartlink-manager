{# Overview Tab - Stats, Daily Interactions, Top Links, Recent Interactions #}

<div class="lr-unified-cards">
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: analyticsData.totalClicks ?? 0,
        description: 'Total Interactions'|t('smartlink-manager'),
        align: 'center',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: analyticsData.uniqueVisitors ?? 0,
        description: 'Unique Visitors'|t('smartlink-manager'),
        align: 'center',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: analyticsData.activeLinks ?? 0,
        description: 'Active Links'|t('smartlink-manager'),
        align: 'center',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: (analyticsData.linksUsedPercentage ?? 0) ~ '%',
        description: 'Engagement Rate'|t('smartlink-manager'),
        align: 'center',
    } only %}
</div>

<h2 class="lr-section-heading">{{ "Traffic Overview"|t('smartlink-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <h3>{{ "Daily Clicks"|t('smartlink-manager') }}</h3>
        <canvas id="clicks-chart"></canvas>
    </div>
</div>

<h2 class="lr-section-heading">{{ "Top {pluginName} (Top 20)"|t('smartlink-manager', {pluginName: smartlinkHelper.pluralDisplayName}) }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <div class="lr-table-scroll">
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th>{{ smartlinkHelper.displayName }}</th>
                        <th>{{ "Site"|t('smartlink-manager') }}</th>
                        <th>{{ "Total Interactions"|t('smartlink-manager') }}</th>
                        <th>{{ "Last Interaction"|t('smartlink-manager') }}</th>
                        <th>{{ "Last Interaction Type"|t('smartlink-manager') }}</th>
                        <th>{{ "Last Destination URL"|t('smartlink-manager') }}</th>
                        <th>{{ "QR Scans"|t('smartlink-manager') }}</th>
                        <th>{{ "Direct Visits"|t('smartlink-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for link in analyticsData.topLinks ?? [] %}
                        {% if (link.enabled ?? true) and (link.clicks > 0) %}
                            <tr>
                                <td>
                                    <a href="{{ url('smartlink-manager/smartlinks/' ~ link.id) }}">
                                        {{ link.name }}
                                    </a>
                                </td>
                                <td>{{ link.siteName ?? '-' }}</td>
                                <td>{{ link.clicks|number }}</td>
                                <td>{{ link.lastClick ? link.lastClick|lrDatetime('short') : '-' }}</td>
                                <td>{{ link.lastInteractionType ?? '-' }}</td>
                                <td>
                                    {% if link.lastDestinationUrl %}
                                        <span title="{{ link.lastDestinationUrl }}">{{ link.lastDestinationUrl|length > 25 ? link.lastDestinationUrl|slice(0, 25) ~ '...' : link.lastDestinationUrl }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ link.qrScans ? link.qrScans|number : '-' }}</td>
                                <td>{{ link.directVisits ? link.directVisits|number : '-' }}</td>
                            </tr>
                        {% endif %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="thin light lr-text-center">{{ "No data for selected period"|t('smartlink-manager') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<h2 class="lr-section-heading">{{ "Latest Interactions (Top 20)"|t('smartlink-manager') }}</h2>

<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <div class="lr-table-scroll">
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th>{{ "Date"|t('smartlink-manager') }}</th>
                        <th>{{ "Time"|t('smartlink-manager') }}</th>
                        <th>{{ smartlinkHelper.displayName }}</th>
                        <th>{{ "Site"|t('smartlink-manager') }}</th>
                        <th>{{ "Type"|t('smartlink-manager') }}</th>
                        <th>{{ "Button"|t('smartlink-manager') }}</th>
                        <th>{{ "Source"|t('smartlink-manager') }}</th>
                        <th>{{ "Destination URL"|t('smartlink-manager') }}</th>
                        <th>{{ "Device"|t('smartlink-manager') }}</th>
                        <th>{{ "Browser"|t('smartlink-manager') }}</th>
                        <th>{{ "OS"|t('smartlink-manager') }}</th>
                        {% if settings.enableGeoDetection %}
                            <th>{{ "Location"|t('smartlink-manager') }}</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for click in analyticsData.recentClicks ?? [] %}
                        <tr>
                            <td>{{ click.dateCreated|lrDate('short') }}</td>
                            <td>{{ click.dateCreated|lrTime('short') }}</td>
                            <td>
                                <a href="{{ cpUrl('smartlink-manager/' ~ click.linkId) }}">{{ click.smartLinkTitle }}</a>
                            </td>
                            <td>
                                {% if click.siteId %}
                                    {% set site = craft.app.sites.getSiteById(click.siteId) %}
                                    {{ site ? site.name : '—' }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>
                                {% if click.clickType == 'button' %}
                                    {{ "Button"|t('smartlink-manager') }}
                                {% else %}
                                    {{ "Redirect"|t('smartlink-manager') }}
                                {% endif %}
                            </td>
                            <td>
                                {% if click.clickType == 'button' and click.platform %}
                                    {% set platformDisplay = {
                                        'ios': 'iOS',
                                        'android': 'Android',
                                        'macos': 'macOS',
                                        'windows': 'Windows',
                                        'linux': 'Linux',
                                        'huawei': 'Huawei',
                                        'amazon': 'Amazon',
                                        'other': 'Other'
                                    } %}
                                    {{ platformDisplay[click.platform] ?? click.platform|capitalize }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>
                                {% if click.source == 'qr' %}
                                    {{ "QR"|t('smartlink-manager') }}
                                {% elseif click.source == 'landing' %}
                                    {{ "Landing"|t('smartlink-manager') }}
                                {% else %}
                                    {{ "Direct"|t('smartlink-manager') }}
                                {% endif %}
                            </td>
                            <td>
                                {% if click.destinationUrl %}
                                    <span title="{{ click.destinationUrl }}">
                                        {{ click.destinationUrl|length > 25 ? click.destinationUrl|slice(0, 25) ~ '...' : click.destinationUrl }}
                                    </span>
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>{{ click.deviceType ? click.deviceType|capitalize : '—' }}</td>
                            <td>{{ click.browser ?? '—' }}</td>
                            <td>{{ click.osName ? click.osName : '—' }}</td>
                            {% if settings.enableGeoDetection %}
                                <td>
                                    {% if click.city and click.country %}
                                        {{ click.city }}, {{ click.country }}
                                    {% elseif click.country %}
                                        {{ click.country }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                            {% endif %}
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="{{ settings.enableGeoDetection ? 12 : 11 }}" class="thin light lr-text-center">{{ "No interactions recorded yet"|t('smartlink-manager') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
