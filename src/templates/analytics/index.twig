{#
 # Analytics Page
 #
 # Uses the base plugin's cp-analytics layout for consistent styling.
 #}

{% extends 'lindemannrock-base/_layouts/cp-analytics' %}

{% set plugin = craft.app.plugins.getPlugin('smartlink-manager') %}
{% set settings = plugin.settings %}
{% set pluginHandle = pluginHandle ?? plugin.id %}

{# Define tabs - Geographic only if geo detection enabled #}
{% set tabsConfig = {
    overview: { label: "Overview"|t('smartlink-manager') },
    'traffic-devices': { label: "Traffic & Devices"|t('smartlink-manager') }
} %}

{% if settings.enableGeoDetection %}
    {% set tabsConfig = tabsConfig|merge({
        geographic: { label: "Geographic"|t('smartlink-manager') }
    }) %}
{% endif %}

{% set analyticsConfig = {
    plugin: {
        handle: pluginHandle ?? 'smartlink-manager',
        name: smartlinkHelper.fullName,
    },
    page: {
        title: 'Analytics'|t('smartlink-manager'),
        subnav: 'analytics',
        crumbs: [
            { label: smartlinkHelper.fullName, url: url('smartlink-manager') },
            { label: 'Analytics'|t('smartlink-manager'), url: url('smartlink-manager/analytics') },
        ],
    },
    tabs: tabsConfig,
    filters: {
        dateRange: {
            current: dateRange,
        },
        sites: {
            enabled: sites|length > 1,
            current: siteId,
            sites: sites,
        },
    },
    export: {
        permission: 'smartLinkManager:exportAnalytics',
        action: 'smartlink-manager/analytics/export',
        extraParams: {siteId: siteId},
    },
    charts: {
        prefix: 'sm',
        dataEndpoint: 'smartlink-manager/analytics/get-data',
    },
} %}

{% block tabs %}
    <div id="overview" class="lr-tab-content">
        {% include 'smartlink-manager/analytics/_partials/overview' %}
    </div>

    <div id="traffic-devices" class="lr-tab-content hidden">
        {% include 'smartlink-manager/analytics/_partials/traffic-devices' %}
    </div>

    {% if settings.enableGeoDetection %}
    <div id="geographic" class="lr-tab-content hidden">
        {% include 'smartlink-manager/analytics/_partials/geographic' %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
{% do view.registerAssetBundle('lindemannrock\\smartlinkmanager\\web\\assets\\analytics\\AnalyticsAsset') %}

{% set smartlinkStrings = {
    noInteraction: "No interaction data available for the selected filters."|t('smartlink-manager'),
    noDevice: "No device data available for the selected filters."|t('smartlink-manager'),
    noBrand: "No device brand data available for the selected filters."|t('smartlink-manager'),
    noOs: "No OS data available for the selected filters."|t('smartlink-manager'),
    noBrowser: "No browser data available for the selected filters."|t('smartlink-manager'),
    noHourly: "No hourly data available for the selected filters."|t('smartlink-manager'),
    clicksLabel: "Clicks"|t('smartlink-manager'),
    peakUsageAt: "Peak usage at"|t('smartlink-manager'),
} %}

{% set smartlinkAnalyticsConfig = {
    prefix: analyticsConfig.charts.prefix,
    dateRange: dateRange,
    siteId: siteId ?? '',
    csrfName: craft.app.config.general.csrfTokenName,
    csrfToken: craft.app.request.csrfToken,
    dataEndpoint: analyticsConfig.charts.dataEndpoint,
    strings: smartlinkStrings,
} %}

{% js %}
window.lrSmartlinkAnalyticsInit({{ smartlinkAnalyticsConfig|json_encode|raw }});
{% endjs %}
{% endblock %}
